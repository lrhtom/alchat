<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<title>AI å£è¯­åŠ©æ‰‹</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<!-- =========  æ›¿æ¢åŸ <style> éƒ¨åˆ†å³å¯  ========= -->
<style>
/* ----  reset  ---- */
/* æ–°å¢ï¼šè¯­è¨€é€‰æ‹©ä¸‹æ‹‰æ¡† */
#langSel{
  padding:8px 12px;
  font-size:15px;
  border-radius:16px;
  border:1px solid rgba(0,0,0,.1);
  background:rgba(255,255,255,.9);
  outline:none;
}
*{box-sizing:border-box;margin:0;padding:0}
body{
  font:15px/1.5 -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans",sans-serif;
  background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);
  height:100vh;display:flex;flex-direction:column;
  color:#333;
}

/* ----  èŠå¤©åŒº  ---- */
#chat{
  flex:1;
  overflow-y:auto;
  padding:12px 16px 80px;          /* åº•éƒ¨ç•™ç©ºé˜²æ­¢è¾“å…¥æ é®æŒ¡ */
  scroll-behavior:smooth;
}
.bubble{
  position:relative;
  max-width:70%;
  padding:10px 14px;
  margin:8px 0;
  border-radius:18px;
  animation:fadeIn .35s ease-out;
  word-break:break-word;
  box-shadow:0 2px 4px rgba(0,0,0,.08);
}
.user{
  background:rgba(0,122,255,.95);
  color:#fff;
  margin-left:auto;
  border-bottom-right-radius:4px;
}
.bot{
  background:rgba(255,255,255,.95);
  color:#000;
  border-bottom-left-radius:4px;
}
/* å°å°¾å·´ */
.user::after,.bot::after{
  content:"";
  position:absolute;
  bottom:-6px;
  width:0;height:0;
  border:6px solid transparent;
}
.user::after{right:0;border-top-color:rgba(0,122,255,.95);}
.bot::after{left:0;border-top-color:rgba(255,255,255,.95);}

@keyframes fadeIn{
  from{opacity:0;transform:translateY(10px)}
  to{opacity:1;transform:translateY(0)}
}

/* ----  åº•éƒ¨ç»ç’ƒæ   ---- */
#bar{
  position:fixed;
  bottom:0;left:0;right:0;
  display:flex;
  align-items:center;
  gap:8px;
  padding:12px 16px;
  background:rgba(255,255,255,.75);
  backdrop-filter:blur(12px);
  border-top:1px solid rgba(255,255,255,.4);
  box-shadow:0 -2px 10px rgba(0,0,0,.05);
}
#input{
  flex:1;
  padding:10px 14px;
  font-size:16px;
  border:1px solid rgba(0,0,0,.08);
  border-radius:20px;
  background:rgba(255,255,255,.9);
  outline:none;
  transition:box-shadow .2s;
}
#input:focus{
  box-shadow:0 0 0 3px rgba(0,122,255,.25);
}
button{
  padding:10px 16px;
  font-size:16px;
  border:none;
  border-radius:50%;
  cursor:pointer;
  color:#fff;
  box-shadow:0 2px 6px rgba(0,0,0,.15);
  transition:transform .15s,box-shadow .15s;
}
button:hover{transform:scale(1.05)}
button:active{transform:scale(.95);box-shadow:0 1px 3px rgba(0,0,0,.15)}
#send{background:#007aff}
#mic{background:#34c759;position:relative}
#mic.active{background:#ff3b30}
/* æŸ”å’Œè„‰å†² */
#mic.active::after{
  content:"";
  position:absolute;
  inset:-6px;
  border-radius:50%;
  border:2px solid #ff3b30;
  animation:pulse 1.4s infinite ease-out;
}
@keyframes pulse{
  0%{transform:scale(.8);opacity:.8}
  70%{transform:scale(1.6);opacity:0}
  100%{transform:scale(.8);opacity:0}
}

/* ----  æ—¶é—´æˆ³  ---- */
.bubble small{
  display:block;
  font-size:11px;
  opacity:.55;
  margin-top:4px;
  text-align:right;
}
</style>
</head>
<body>

<!-- =================  é¡µé¢ç»“æ„  ================= -->
<!-- èŠå¤©åŒº -->
<div id="chat"></div>

<!-- åº•éƒ¨æ“ä½œæ ï¼ˆæ–°å¢ä¸€ä¸ªä¸‹æ‹‰æ¡†ï¼‰ -->
<div id="bar">
  <select id="langSel">
    <option value="en">English</option>
    <option value="ja">æ—¥æœ¬èª</option>
  </select>
  <input id="input" placeholder="è¾“å…¥è‹±æ–‡æˆ–é•¿æŒ‰éº¦å…‹é£â€¦" autocomplete="off" />
  <button id="send">å‘é€</button>
  <button id="mic">ğŸ¤</button>
</div>

<script>
/* =========  é…ç½®  ========= */
const BASE_URL = 'https://ark.cn-beijing.volces.com/api/v3';
const API_KEY  = '4c335d77-5b75-468a-aff2-164f240ecc85';
const MODEL    = 'ep-20251010224847-h9g7p';

/* æ–°å¢ï¼šè¯­è¨€å¯¹ç…§è¡¨ */
const LANG = {
  en: {
    SYSTEM: 'You are a helpful English assistant. Always reply in English.æ¯æ¬¡è°ˆè¯ä¸å¯ä»¥å¤ªå¤šè¯ï¼ˆ100è¯ä¸Šé™ï¼‰',
    PLACEHOLDER: 'è¾“å…¥è‹±æ–‡æˆ–é•¿æŒ‰éº¦å…‹é£â€¦',
    SEND: 'å‘é€',
    MIC_ALERT: 'è¯·ä½¿ç”¨ Chrome/Edge æµè§ˆå™¨',
    ERROR: 'Error: '
  },
  ja: {
    SYSTEM: 'ã‚ãªãŸã¯è¦ªåˆ‡ãªæ—¥æœ¬èªã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆã§ã™ã€‚å¸¸ã«æ—¥æœ¬èªã§è¿”äº‹ã—ã¦ãã ã•ã„ã€‚æ¯å›ã®ä¼šè©±ã¯100èªä»¥å†…ã«æŠ‘ãˆã¦ãã ã•ã„ã€‚',
    PLACEHOLDER: 'æ—¥æœ¬èªã§å…¥åŠ›ã€ã¾ãŸã¯ãƒã‚¤ã‚¯é•·æŠ¼ã—â€¦',
    SEND: 'é€ä¿¡',
    MIC_ALERT: 'Chrome/Edgeãƒ–ãƒ©ã‚¦ã‚¶ã‚’ã”åˆ©ç”¨ãã ã•ã„',
    ERROR: 'ã‚¨ãƒ©ãƒ¼: '
  }
};

/* =========  DOM  ========= */
const chatBox = document.getElementById('chat');
const inputEl = document.getElementById('input');
const sendBtn = document.getElementById('send');
const micBtn  = document.getElementById('mic');
const langSel = document.getElementById('langSel');   // æ–°å¢

/* =========  çŠ¶æ€  ========= */
let loading   = false;
let speaking  = false;
let ttsUnlocked = false;
const MAX_HIST = 20;
let messages  = [];   // å…ˆç•™ç©ºï¼Œç­‰åˆ‡æ¢è¯­è¨€åå†å¡«

/* æ–°å¢ï¼šå½“å‰è¯­è¨€ */
let currentLang = langSel.value;   // en / ja

/* æ–°å¢ï¼šæ ¹æ®è¯­è¨€é‡æ–°ç”Ÿæˆç³»ç»Ÿæç¤º & ç•Œé¢æ–‡å­— */
function applyLang(lang){
  currentLang = lang;
  // 1. ç³»ç»Ÿæç¤º
  messages = [{role:'system', content: LANG[lang].SYSTEM}];
  // 2. è¾“å…¥æ¡†æç¤ºæ–‡å­—
  inputEl.placeholder = LANG[lang].PLACEHOLDER;
  // 3. æŒ‰é’®æ–‡å­—
  sendBtn.textContent = LANG[lang].SEND;
  // 4. æ¸…å±ï¼ˆå¯é€‰ï¼šåˆ‡æ¢è¯­è¨€åé‡æ–°å¼€å§‹ï¼‰
  chatBox.innerHTML = '';
}
// åˆå§‹åŒ–ä¸€æ¬¡
applyLang(currentLang);

/* æ–°å¢ï¼šä¸‹æ‹‰æ¡†åˆ‡æ¢ */
langSel.addEventListener('change',()=> applyLang(langSel.value) );

/* =========  TTS è§£é” ========= */
function unlockTTS(){
  if(ttsUnlocked) return;
  const u=new SpeechSynthesisUtterance('');u.volume=0;speechSynthesis.speak(u);
  ttsUnlocked = true;
}
function speechSpeak(u){
  if(!ttsUnlocked) unlockTTS();
  speechSynthesis.speak(u);
}

/* æœ—è¯»ï¼šå¤±è´¥è‡ªåŠ¨é‡è¯•ä¸€æ¬¡ */
function speak(text){
  if(!('speechSynthesis' in window)) return;
  speaking = true;
  const u = new SpeechSynthesisUtterance(text);
  // å…³é”®ï¼šæ ¹æ®å½“å‰è¯­è¨€é€‰å£°éŸ³
  u.lang = currentLang==='ja' ? 'ja-JP' : 'en-US';
  let retried = false;
  u.onend = () => speaking = false;
  u.onerror = () => {
    if(!retried){ retried=true; speechSpeak(new SpeechSynthesisUtterance(text)); }
    else speaking=false;
  };
  speechSpeak(u);
}

/* =========  èŠå¤©æ ¸å¿ƒ  ========= */
async function askBot(){
  const res = await fetch(`${BASE_URL}/chat/completions`,{
    method:'POST',
    headers:{
      'Content-Type':'application/json',
      'Authorization':`Bearer ${API_KEY}`
    },
    body:JSON.stringify({
      model:MODEL,
      messages,
      temperature:0.7
    })
  });
  if(!res.ok) throw new Error(await res.text());
  const json=await res.json();
  return json.choices?.[0]?.message?.content??'';
}

function addBubble(role,text){
  const div=document.createElement('div');
  div.className='bubble '+role;
  div.textContent=text;
  chatBox.appendChild(div);
  chatBox.scrollTop=chatBox.scrollHeight;
}

async function send(){
  const txt=inputEl.value.trim();
  if(!txt||loading) return;
  inputEl.value='';
  addBubble('user',txt);

  messages.push({role:'user', content:txt});
  if(messages.length>MAX_HIST) messages.splice(1,1);

  loading=true; sendBtn.disabled=true;
  try{
    const reply=await askBot();
    addBubble('bot',reply);
    speak(reply);
    messages.push({role:'assistant', content:reply});
    if(messages.length>MAX_HIST) messages.splice(1,1);
  }catch(e){
    addBubble('bot', LANG[currentLang].ERROR + e.message);
  }finally{
    loading=false; sendBtn.disabled=false;
  }
}

/* =========  è¯­éŸ³è¾“å…¥  ========= */
let recog,recording=false;
function startRecog(){
  if(!('webkitSpeechRecognition' in window)){
    alert(LANG[currentLang].MIC_ALERT);
    return;
  }
  recog=new webkitSpeechRecognition();
  recog.lang = currentLang==='ja' ? 'ja-JP' : 'en-US';   // è¯†åˆ«è¯­è¨€åŒæ­¥
  recog.interimResults=true;
  recog.continuous=true;
  recog.onresult=e=>{
    let final='';
    for(let i=e.resultIndex;i<e.results.length;++i)
      if(e.results[i].isFinal) final+=e.results[i][0].transcript+' ';
    if(final) inputEl.value+=final;
  };
  recog.onend=()=>{ if(recording) recog.start(); };
  recording=true;
  micBtn.classList.add('active');
  recog.start();
}
function stopRecog(){
  recording=false;
  micBtn.classList.remove('active');
  if(recog) recog.stop();
}
micBtn.addEventListener('click',()=> recording ? stopRecog() : startRecog() );

/* =========  å‘é€æŒ‰é’® / å›è½¦  ========= */
sendBtn.addEventListener('click',send);
inputEl.addEventListener('keydown',e=>{
  if(e.key==='Enter'&&!e.shiftKey){ e.preventDefault(); send(); }
});
</script>
</body>
</html>